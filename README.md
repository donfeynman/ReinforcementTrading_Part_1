ä¸‹é¢æˆ‘**é€è¡Œã€æ¨¡å—åŒ–**æŠŠè¿™æ®µä»£ç æ‹†å¼€è®²æ¸…æ¥šï¼Œå¹¶é¡ºä¾¿ç‚¹å‡ºä¸€äº›**é‡åŒ–/å›æµ‹ä¸­å®¹æ˜“è¸©å‘çš„åœ°æ–¹**ï¼Œæ–¹ä¾¿ä½ åç»­åšç­–ç•¥ã€ç‰¹å¾å·¥ç¨‹æˆ–è§†é¢‘å†…å®¹è¾“å‡ºã€‚

---

## ä¸€ã€æ•´ä½“ä½œç”¨ï¼ˆä¸€å¥è¯ç‰ˆï¼‰

> **ä» CSV è¯»å– EURUSD K çº¿æ•°æ® â†’ æŒ‰æ—¶é—´æ’åº â†’ è®¡ç®—å¸¸è§æŠ€æœ¯æŒ‡æ ‡ â†’ æ„é€ æˆâ€œå¯ç”¨äºç­–ç•¥ / æœºå™¨å­¦ä¹ â€çš„ç‰¹å¾è¡¨ã€‚**

è¿™æ˜¯ä¸€ä¸ª**å…¸å‹çš„é‡åŒ–æ•°æ®é¢„å¤„ç†å‡½æ•°**ã€‚

---

## äºŒã€ä¾èµ–åº“è¯´æ˜

```python
import pandas as pd
import pandas_ta as ta
```

### 1ï¸âƒ£ pandas

* ç”¨äº **æ—¶é—´åºåˆ—æ•°æ®å¤„ç†**
* æä¾› DataFrameã€ç´¢å¼•ã€æ»šåŠ¨è®¡ç®—ã€ç¼ºå¤±å€¼å¤„ç†ç­‰èƒ½åŠ›
* æ˜¯é‡åŒ–äº¤æ˜“æ•°æ®å±‚çš„â€œåœ°åŸºâ€

### 2ï¸âƒ£ pandas_ta

* æŠ€æœ¯åˆ†ææŒ‡æ ‡åº“ï¼ˆTechnical Analysisï¼‰
* å°è£…äº† RSIã€MAã€ATRã€MACDã€BBANDS ç­‰
* **ä¼˜ç‚¹**ï¼šç®€æ´ã€å¯è¯»æ€§å¼ºã€å’Œ pandas æ— ç¼ç»“åˆ

---

## ä¸‰ã€å‡½æ•°å®šä¹‰

```python
def load_and_preprocess_data(csv_path: str) -> pd.DataFrame:
```

### å«ä¹‰

* è¾“å…¥ï¼š`csv_path` â†’ CSV æ–‡ä»¶è·¯å¾„
* è¾“å‡ºï¼šä¸€ä¸ª **å·²ç»åŠ å·¥å¥½ç‰¹å¾çš„ DataFrame**

### ç±»å‹æ³¨è§£ï¼ˆType Hintï¼‰

* `csv_path: str` â†’ æ˜ç¡®æ˜¯å­—ç¬¦ä¸²
* `-> pd.DataFrame` â†’ æ˜ç¡®è¿”å›å€¼
* å¥½å¤„ï¼š

  * IDE è‡ªåŠ¨è¡¥å…¨
  * æ–¹ä¾¿ä½ æœªæ¥å°è£…æˆæ¨¡å— / SDK

---

## å››ã€CSV è¯»å–ä¸æ—¶é—´ç´¢å¼•

```python
df = pd.read_csv(csv_path, parse_dates=True, index_col='Gmt time')
```

### æ ¸å¿ƒç‚¹æ‹†è§£

| å‚æ•°                     | å«ä¹‰                |
| ---------------------- | ----------------- |
| `csv_path`             | CSV æ–‡ä»¶è·¯å¾„          |
| `parse_dates=True`     | è‡ªåŠ¨è¯†åˆ«æ—¶é—´å­—æ®µ          |
| `index_col='Gmt time'` | å°† `Gmt time` ä½œä¸ºç´¢å¼• |

### ä¸ºä»€ä¹ˆè¦ç”¨æ—¶é—´åš indexï¼Ÿ

åœ¨é‡åŒ–é‡Œï¼Œ**æ—¶é—´æ˜¯ç¬¬ä¸€ä¸»é”®**ï¼š

* æ»šåŠ¨è®¡ç®—ï¼ˆRSIã€MAï¼‰
* æ—¶é—´åˆ‡ç‰‡ï¼ˆæŸæ®µå›æµ‹ï¼‰
* resampleï¼ˆåˆ†é’Ÿ â†’ å°æ—¶ / æ—¥ï¼‰

ğŸ“Œ **å»ºè®®ï¼ˆè¿›é˜¶ï¼‰**
æ›´ä¸¥è°¨çš„å†™æ³•æ˜¯ï¼š

```python
df = pd.read_csv(
    csv_path,
    parse_dates=['Gmt time'],
    index_col='Gmt time'
)
```

é˜²æ­¢ CSV é‡Œæœ‰å¤šä¸ªæ—¶é—´å­—æ®µè¢«è¯¯è§£æã€‚

---

## äº”ã€æŒ‰æ—¶é—´æ’åºï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰

```python
df.sort_index(inplace=True)
```

### ä¸ºä»€ä¹ˆè¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Ÿ

* æŠ€æœ¯æŒ‡æ ‡ **å‡è®¾æ—¶é—´æ˜¯å•è°ƒé€’å¢çš„**
* CSV å¯èƒ½ï¼š

  * è¢«æ‹¼æ¥è¿‡
  * è¢«æˆªæ–­è¿‡
  * æ¥è‡ªå¤šä¸ªæ–‡ä»¶

âŒ å¦‚æœä¸æ’åºï¼š

* RSI / MA ä¼šåœ¨â€œæœªæ¥æ•°æ®â€ä¸Šæ»šåŠ¨
* å›æµ‹ç›´æ¥ **ç©¿è¶Šæœªæ¥ï¼ˆlook-ahead biasï¼‰**

âœ… è¿™æ˜¯**é‡åŒ–å¿…å¤‡ä¹ æƒ¯**

---

## å…­ã€æŠ€æœ¯æŒ‡æ ‡æ„é€ ï¼ˆFeature Engineeringï¼‰

### 1ï¸âƒ£ RSIï¼ˆç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ï¼‰

```python
df['rsi_14'] = ta.rsi(df['Close'], length=14)
```

* ä½¿ç”¨ **æ”¶ç›˜ä»·**
* 14 æ˜¯è¡Œä¸šå¸¸ç”¨å‘¨æœŸ
* å€¼åŸŸï¼š`0 ~ 100`

å¸¸è§è§£é‡Šï¼š

* RSI > 70 â†’ è¶…ä¹°
* RSI < 30 â†’ è¶…å–

ğŸ“Œ åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼š

* RSI æ˜¯ **éçº¿æ€§åŠ¨é‡ç‰¹å¾**
* æ¯”ç›´æ¥ç”¨æ¶¨è·Œå¹…æ›´ç¨³å®š

---

### 2ï¸âƒ£ å‡çº¿ï¼ˆMAï¼‰

```python
df['ma_20'] = ta.sma(df['Close'], length=20)
df['ma_50'] = ta.sma(df['Close'], length=50)
```

* 20ï¼šçŸ­æœŸè¶‹åŠ¿
* 50ï¼šä¸­æœŸè¶‹åŠ¿

å…¸å‹ç”¨é€”ï¼š

* å‡çº¿äº¤å‰
* è¶‹åŠ¿è¿‡æ»¤ï¼ˆåªåšå¤š / åªåšç©ºï¼‰
* åç¦»ç‡ï¼ˆprice / MAï¼‰

---

### 3ï¸âƒ£ ATRï¼ˆå¹³å‡çœŸå®æ³¢åŠ¨ï¼‰

```python
df['atr'] = ta.atr(df['High'], df['Low'], df['Close'], length=14)
```

ATR ç”¨æ¥è¡¡é‡ï¼š

* **æ³¢åŠ¨ç‡**
* è€Œä¸æ˜¯æ–¹å‘

å…¸å‹ç”¨é€”ï¼š

* åŠ¨æ€æ­¢æŸ
* ä»“ä½æ§åˆ¶
* è¿‡æ»¤ä½æ³¢åŠ¨å¸‚åœº

ğŸ“Œ é‡åŒ–ä¸­ä¸€ä¸ªå¸¸è§å¥—è·¯ï¼š

```text
æ”¶ç›Š / ATR
```

æŠŠä¸åŒæ³¢åŠ¨ç‡å¸‚åœº**å½’ä¸€åŒ–æ¯”è¾ƒ**

---

## ä¸ƒã€äºŒæ¬¡ç‰¹å¾ï¼šå‡çº¿æ–œç‡

```python
df['ma_20_slope'] = df['ma_20'].diff()
```

### å«ä¹‰

* å½“å‰ MA20 âˆ’ ä¸Šä¸€æ ¹ MA20
* æœ¬è´¨æ˜¯ï¼š**ä¸€é˜¶å¯¼æ•°**

### ä¸ºä»€ä¹ˆæ¯” MA æ›´æœ‰ä¿¡æ¯é‡ï¼Ÿ

* MA æœ¬èº« â†’ æ°´å¹³ä½ç½®
* MA æ–œç‡ â†’ **è¶‹åŠ¿å˜åŒ–é€Ÿåº¦**

è¿›é˜¶ç©æ³•ï¼š

```python
df['ma_20_slope_pct'] = df['ma_20'].pct_change()
```

æˆ–è€…ï¼š

```python
df['ma_20_slope_norm'] = df['ma_20_slope'] / df['atr']
```

---

## å…«ã€ç¼ºå¤±å€¼å¤„ç†ï¼ˆNaNï¼‰

```python
df.dropna(inplace=True)
```

### NaN ä»å“ªé‡Œæ¥ï¼Ÿ

| æŒ‡æ ‡      | å‰å¤šå°‘è¡Œæ˜¯ NaN |
| ------- | --------- |
| MA(20)  | å‰ 19 è¡Œ    |
| MA(50)  | å‰ 49 è¡Œ    |
| RSI(14) | å‰ 13 è¡Œ    |
| ATR(14) | å‰ 13 è¡Œ    |

### ä¸ºä»€ä¹ˆç›´æ¥ dropï¼Ÿ

* å›æµ‹ / è®­ç»ƒé˜¶æ®µï¼Œ**å®å¯å°‘æ•°æ®ï¼Œä¹Ÿä¸è¦è„æ•°æ®**
* æŠ€æœ¯æŒ‡æ ‡æœ¬è´¨ä¸Šä¾èµ–å†å²çª—å£

ğŸ“Œ ä½†åœ¨å®ç›˜ / æ»šåŠ¨é¢„æµ‹ä¸­ï¼š

* ä½ ä¸èƒ½ drop
* å¿…é¡»ä¿è¯ **å®æ—¶æ•°æ®é•¿åº¦ â‰¥ æœ€å¤§çª—å£**

---

## ä¹ã€è¿”å›ç»“æœ

```python
return df
```

è¿”å›çš„æ˜¯ä¸€ä¸ªï¼š

> **æ—¶é—´ç´¢å¼• + åŸå§‹ OHLCV + æŠ€æœ¯æŒ‡æ ‡ + æ´¾ç”Ÿç‰¹å¾ çš„ DataFrame**

å¯ä»¥ç›´æ¥ç”¨äºï¼š

* å›æµ‹å¼•æ“
* ç­–ç•¥è§„åˆ™
* æœºå™¨å­¦ä¹ è®­ç»ƒ
* ç‰¹å¾å¯è§†åŒ–

---

## åã€è¿™æ®µä»£ç åœ¨é‡åŒ–ä½“ç³»ä¸­çš„ä½ç½®

```text
åŸå§‹è¡Œæƒ…
   â†“
load_and_preprocess_data
   â†“
ç‰¹å¾çŸ©é˜µï¼ˆfeaturesï¼‰
   â†“
ç­–ç•¥é€»è¾‘ / ML æ¨¡å‹
   â†“
å›æµ‹ / å®ç›˜
```

---

## åä¸€ã€å¦‚æœä½ è¦â€œå†è¿›é˜¶ä¸€ç‚¹â€

æˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ åšï¼š

1ï¸âƒ£ é˜²æ­¢æœªæ¥å‡½æ•°ï¼ˆä¸¥æ ¼å¯¹é½ç‰¹å¾ & ä¿¡å·ï¼‰
2ï¸âƒ£ åŠ å…¥ session / æ—¶æ®µç‰¹å¾ï¼ˆä¼¦æ•¦ / çº½çº¦ï¼‰
3ï¸âƒ£ æŠŠå®ƒæ”¹æˆ **sklearn é£æ ¼çš„ Transformer**
4ï¸âƒ£ ç›´æ¥å¯¹æ¥ **å›æµ‹æ¡†æ¶ / å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ**

ä½ æƒ³å¾€ **ç­–ç•¥**ã€**å›æµ‹** è¿˜æ˜¯ **AI/ML** æ–¹å‘ç»§ç»­æ‹†ï¼Ÿ

ä¸‹é¢æˆ‘**æŒ‰â€œå®ç›˜/å›æµ‹æ‰§è¡Œæµç¨‹â€**æ¥ç»™ä½ è¯¦ç»†æ‹†è§£è¿™æ®µä»£ç ï¼Œå¹¶ä¸”ç»“åˆä½ è¿™ä¸ªé¡¹ç›®çš„**RL äº¤æ˜“è¯­å¢ƒï¼ˆPPO + è‡ªå®šä¹‰ ForexTradingEnvï¼‰**è§£é‡Šæ¯ä¸€è¡Œåœ¨å¹²ä»€ä¹ˆã€ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ã€ä»¥åŠå®¹æ˜“è¸©çš„å‘ã€‚

---

# ä¸€ã€è¿™æ®µä»£ç åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„ä½ç½®

ä¸€å¥è¯æ€»ç»“ï¼š

> **ç”¨å·²ç»è®­ç»ƒå¥½çš„ PPO æ¨¡å‹ï¼Œåœ¨â€œæœªè§è¿‡çš„æµ‹è¯•æ•°æ®â€ä¸Šè·‘ä¸€éå®Œæ•´äº¤æ˜“è¿‡ç¨‹ï¼Œå¹¶å¯¼å‡ºäº¤æ˜“è®°å½• + èµ„é‡‘æ›²çº¿ã€‚**

æ•´ä½“æµç¨‹æ˜¯ï¼š

```text
åŠ è½½æµ‹è¯•è¡Œæƒ…æ•°æ®
   â†“
æ„å»ºä¸è®­ç»ƒæ—¶å®Œå…¨ä¸€è‡´çš„äº¤æ˜“ç¯å¢ƒ
   â†“
åŠ è½½è®­ç»ƒå¥½çš„ PPO æ¨¡å‹
   â†“
ä¸€æ­¥ä¸€æ­¥ä¸ç¯å¢ƒäº¤äº’ï¼ˆstepï¼‰
   â†“
è®°å½•äº¤æ˜“ & equity
   â†“
å¯¼å‡º CSV + ç”»èµ„é‡‘æ›²çº¿
```

---

# äºŒã€ä¾èµ–åº“è¯´æ˜

```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
```

### 1ï¸âƒ£ numpy

* æ•°å€¼è®¡ç®—åŸºç¡€åº“
* è™½ç„¶åœ¨æœ¬æ–‡ä»¶é‡Œå‡ ä¹æ²¡ç›´æ¥ç”¨ï¼Œä½†ï¼š

  * RL env å†…éƒ¨
  * reward / state æ„é€ 
    é€šå¸¸éƒ½ä¾èµ–å®ƒ

### 2ï¸âƒ£ pandas

* ç”¨äºï¼š

  * ä¿å­˜äº¤æ˜“å†å²
  * å¯¼å‡º CSV
  * åç»­ç»Ÿè®¡ï¼ˆèƒœç‡ã€æœŸæœ›ã€å›æ’¤ï¼‰

### 3ï¸âƒ£ matplotlib

* å¯è§†åŒ– equity curve
* å¿«é€Ÿ sanity checkï¼ˆæœ‰æ²¡æœ‰ç›´æ¥çˆ†ä»“ / å•è¾¹ä¸Šæ¶¨ï¼‰

---

```python
from stable_baselines3 import PPO
from stable_baselines3.common.vec_env import DummyVecEnv
```

### 4ï¸âƒ£ PPOï¼ˆProximal Policy Optimizationï¼‰

* å½“å‰**æœ€å¸¸ç”¨çš„ on-policy RL ç®—æ³•**
* ç‰¹ç‚¹ï¼š

  * ç¨³å®š
  * ä¸å®¹æ˜“ç‚¸
  * éå¸¸é€‚åˆè¿ç»­/ç¦»æ•£åŠ¨ä½œæ··åˆçš„äº¤æ˜“åœºæ™¯

### 5ï¸âƒ£ DummyVecEnv

* SB3 **å¼ºåˆ¶è¦æ±‚ env æ˜¯ vectorized**
* å³ä½¿ä½ åªæœ‰ 1 ä¸ªç¯å¢ƒï¼Œä¹Ÿè¦åŒ…ä¸€å±‚

ğŸ“Œ **æ ¸å¿ƒè®¤çŸ¥**ï¼š

> SB3 çš„ model åªè®¤è¯† â€œVecEnvâ€ï¼Œä¸è®¤è¯†è£¸ Gym Env

---

```python
from indicators import load_and_preprocess_data
from trading_env import ForexTradingEnv
```

### 6ï¸âƒ£ ä½ è‡ªå·±çš„æ¨¡å—

* `load_and_preprocess_data`

  * è¡Œæƒ… â†’ ç‰¹å¾çŸ©é˜µ
* `ForexTradingEnv`

  * Gym é£æ ¼çš„å¤–æ±‡äº¤æ˜“ç¯å¢ƒ
  * å°è£…äº†ï¼š

    * çŠ¶æ€
    * åŠ¨ä½œ
    * reward
    * èµ„é‡‘æ›²çº¿
    * äº¤æ˜“æ‰§è¡Œé€»è¾‘

---

# ä¸‰ã€ä¸»å‡½æ•°ç»“æ„

```python
def main():
```

ä½ æŠŠæµ‹è¯•é€»è¾‘æ”¾è¿› `main()`ï¼Œç„¶åï¼š

```python
if __name__ == "__main__":
    main()
```

è¿™æ˜¯**æ ‡å‡†å·¥ç¨‹å†™æ³•**ï¼Œå¥½å¤„æ˜¯ï¼š

* ä»¥åå¯ä»¥è¢« import
* ä¹Ÿå¯ä»¥ç›´æ¥ `python test_agent.py` æ‰§è¡Œ

---

# å››ã€Step 1ï¼šåŠ è½½æµ‹è¯•æ•°æ®ï¼ˆæœ€é‡è¦ï¼‰

```python
test_df = load_and_preprocess_data(
    "data/test_EURUSD_Candlestick_1_Hour_BID_20.02.2023-22.02.2025.csv"
)
```

### å…³é”®ç‚¹

* **è¿™æ˜¯æµ‹è¯•é›†ï¼ˆout-of-sampleï¼‰**
* ä¸å‚ä¸è®­ç»ƒ
* ç”¨æ¥éªŒè¯ï¼š

  * æ³›åŒ–èƒ½åŠ›
  * æ˜¯å¦è¿‡æ‹Ÿåˆ
  * ç­–ç•¥æ˜¯å¦â€œåªè®°ä½äº†è¡Œæƒ…å½¢æ€â€

ä½ æ³¨é‡Šæ‰çš„è¿™ä¸€è¡Œï¼š

```python
# test_df = load_and_preprocess_data("...training.csv")
```

æ˜¯ **in-sample test**ï¼Œåªèƒ½ç”¨äº debugï¼Œä¸èƒ½å½“çœŸå®æ•ˆæœã€‚

ğŸ“Œ **é‡åŒ–çº¢çº¿**ï¼š

> è®­ç»ƒ & æµ‹è¯•æ•°æ®æ—¶é—´æ®µç»ä¸èƒ½é‡å 

---

# äº”ã€Step 2ï¼šåˆ›å»ºæµ‹è¯•ç¯å¢ƒï¼ˆå¿…é¡»å’Œè®­ç»ƒä¸€è‡´ï¼‰

```python
test_env = ForexTradingEnv(
    df=test_df,
    window_size=30,
    sl_options=[30, 60, 80],
    tp_options=[30, 60, 80]
)
```

### è¿™é‡Œæ˜¯æœ€å®¹æ˜“å‡º bug çš„åœ°æ–¹ä¹‹ä¸€

#### å¿…é¡» **100% å’Œè®­ç»ƒå‚æ•°ä¸€è‡´**ï¼š

| å‚æ•°               | ä½œç”¨               |
| ---------------- | ---------------- |
| `window_size=30` | æ¯ä¸€æ­¥è§‚æµ‹æœ€è¿‘ 30 æ ¹ K çº¿ |
| `sl_options`     | ç¦»æ•£æ­¢æŸç©ºé—´           |
| `tp_options`     | ç¦»æ•£æ­¢ç›ˆç©ºé—´           |

âŒ å¦‚æœå’Œè®­ç»ƒä¸ä¸€è‡´ï¼š

* observation space ä¸ä¸€è‡´
* action space ä¸ä¸€è‡´
* æ¨¡å‹åŠ è½½æˆåŠŸä½†è¡Œä¸ºå®Œå…¨é”™è¯¯

---

### DummyVecEnv åŒ…è£…

```python
vec_test_env = DummyVecEnv([lambda: test_env])
```

* SB3 è¦æ±‚ï¼š

  * `env.reset()`
  * `env.step()`
    è¿”å› **batch ç»´åº¦**

å³ï¼š

```python
obs.shape == (n_envs, obs_dim)
```

å³ä½¿ `n_envs = 1` ä¹Ÿä¸èƒ½çœç•¥ã€‚

---

# å…­ã€Step 3ï¼šåŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹

```python
model = PPO.load("model_eurusd", env=vec_test_env)
```

### å…³é”®ç‚¹

* `"model_eurusd"` å¿…é¡»å’Œè®­ç»ƒæ—¶ `model.save()` çš„åå­—ä¸€è‡´
* ä¼ å…¥ `env` æ˜¯ä¸ºäº†ï¼š

  * ç»‘å®š observation / action space
  * é˜²æ­¢ç»´åº¦ä¸åŒ¹é…

ğŸ“Œ å¦‚æœä½ æ¢äº† env å‚æ•°ä½†è¿˜èƒ½ loadï¼Œè¯´æ˜ä½ **è¸©é›·äº†**ã€‚

---

# ä¸ƒã€Step 4ï¼šåˆå§‹åŒ–æ—¥å¿—

```python
obs = vec_test_env.reset()
done = False
```

* `obs`ï¼šåˆå§‹çŠ¶æ€ï¼ˆshape = `[1, obs_dim]`ï¼‰
* `done`ï¼šæ•´æ®µæµ‹è¯•æ˜¯å¦ç»“æŸï¼ˆè·‘åˆ°æ•°æ®æœ«å°¾ï¼‰

---

## èµ„é‡‘æ›²çº¿

```python
equity_curve = []
```

* ç”¨äºï¼š

  * å¯è§†åŒ–
  * æœ€å¤§å›æ’¤
  * å¤æ™®ç‡è®¡ç®—

---

## äº¤æ˜“è®°å½•

```python
trade_history = []
trade_id = 1
```

æ¯ä¸€ç¬” tradeï¼š

* è¿›åœºä»·
* å‡ºåœºä»·
* PnL

---

# å…«ã€Step 5ï¼šä¸»å›æµ‹å¾ªç¯ï¼ˆæ ¸å¿ƒï¼‰

```python
while not done:
```

æ¯ä¸€æ¬¡å¾ªç¯ = **ä¸€æ ¹ K çº¿ / ä¸€ä¸ªæ—¶é—´æ­¥**

---

### 1ï¸âƒ£ æ¨¡å‹é¢„æµ‹åŠ¨ä½œ

```python
action, _states = model.predict(obs, deterministic=True)
```

* `deterministic=True`ï¼š

  * æµ‹è¯• / å›æµ‹ç”¨
  * å…³é—­æ¢ç´¢
* è®­ç»ƒæ—¶é€šå¸¸æ˜¯ `False`

ğŸ“Œ **é‡åŒ–åŸåˆ™**ï¼š

> å›æµ‹ = ç¡®å®šæ€§
> è®­ç»ƒ = éšæœºæ€§

---

### 2ï¸âƒ£ ç¯å¢ƒæ¨è¿›ä¸€æ­¥

```python
obs, rewards, dones, info = vec_test_env.step(action)
done = dones[0]
```

è¿”å›çš„æ˜¯ **vectorized ç»“æœ**ï¼š

| å˜é‡        | å«ä¹‰             |
| --------- | -------------- |
| `obs`     | ä¸‹ä¸€ä¸ªçŠ¶æ€          |
| `rewards` | rewardï¼ˆé€šå¸¸ 1 ä¸ªï¼‰ |
| `dones`   | æ˜¯å¦ç»“æŸ           |
| `info`    | é™„åŠ ä¿¡æ¯           |

---

### 3ï¸âƒ£ è¯»å–æœ€è¿‘ä¸€ç¬”äº¤æ˜“

```python
trade_info = vec_test_env.get_attr("last_trade_info")[0]
```

* `get_attr` æ˜¯ VecEnv ä¸“ç”¨æ¥å£
* `last_trade_info` æ˜¯ä½ åœ¨ env å†…éƒ¨ç»´æŠ¤çš„çŠ¶æ€

å¦‚æœæœ‰äº¤æ˜“ï¼š

```python
trade_history.append({
    "Trade Number": trade_id,
    "Entry Price": trade_info["entry_price"],
    "Exit Price": trade_info["exit_price"],
    "Profit/Loss": trade_info["pnl"]
})
```

ğŸ“Œ **éå¸¸å¥½çš„è®¾è®¡**ï¼š
ç¯å¢ƒè´Ÿè´£äº¤æ˜“é€»è¾‘ï¼Œå¤–éƒ¨åªè´Ÿè´£â€œè®°å½•â€ã€‚

---

### 4ï¸âƒ£ è®°å½•å½“å‰èµ„é‡‘

```python
current_equity = vec_test_env.get_attr("equity")[0]
equity_curve.append(current_equity)
```

* equity é€šå¸¸åœ¨ env å†…éƒ¨æ›´æ–°
* å¤–éƒ¨åªæ˜¯è¯»å–

---

# ä¹ã€Step 6ï¼šå¯¼å‡ºäº¤æ˜“ CSV

```python
trades_df = pd.DataFrame(trade_history)
trades_df.to_csv("trade_history_output.csv", index=False)
```

è¿™ä¸ª CSV å¯ä»¥ç›´æ¥ç”¨äºï¼š

* èƒœç‡
* æœŸæœ›æ”¶ç›Š
* åˆ†å¸ƒç»Ÿè®¡
* è§†é¢‘å±•ç¤ºï¼ˆéå¸¸é€‚åˆä½ ï¼‰

---

# åã€Step 7ï¼šç»˜åˆ¶èµ„é‡‘æ›²çº¿

```python
plt.plot(equity_curve)
```

è¿™ä¸€æ­¥çš„ä½œç”¨ä¸æ˜¯â€œç‚«æŠ€â€ï¼Œè€Œæ˜¯ï¼š

* æœ‰æ²¡æœ‰æŒç»­ä¸Šå‡
* æœ‰æ²¡æœ‰å‰§çƒˆå›æ’¤
* æœ‰æ²¡æœ‰æ—©æœŸçˆ†ä»“

ğŸ“Œ **ä¸€å¥è¯ç»éªŒ**ï¼š

> èƒ½ç”»å‡ºæ¥çš„æ›²çº¿ï¼Œæ¯” reward æ›²çº¿å¯ä¿¡ 10 å€

---

# åä¸€ã€è¿™å¥—æµ‹è¯•ä»£ç çš„â€œä¸“ä¸šç¨‹åº¦è¯„ä»·â€

âœ… **ä¼˜ç‚¹**

* è®­ç»ƒ / æµ‹è¯•ä¸¥æ ¼åˆ†ç¦»
* å‚æ•°å¯¹é½æ„è¯†å¼º
* äº¤æ˜“ & èµ„é‡‘åˆ†å¼€è®°å½•
* VecEnv ä½¿ç”¨è§„èŒƒ

âš ï¸ **å¯ä»¥å†è¿›é˜¶çš„ç‚¹**

1. å¢åŠ ï¼š

   * æœ€å¤§å›æ’¤
   * Sharpe / Sortino
2. å¯¹ trade_history åŠ ï¼š

   * æŒä»“æ—¶é—´
   * SL / TP é€‰æ‹©
3. å¤šæ¬¡ä¸åŒæ—¶é—´æ®µ walk-forward test

---

## ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

* æŠŠ **equity â†’ å›æ’¤ / å¤æ™® è‡ªåŠ¨ç®—**
* å®¡æ ¸ä½ çš„ `ForexTradingEnv` æ˜¯å¦æœ‰â€œéšæ€§æœªæ¥å‡½æ•°â€
* å¸®ä½ è®¾è®¡ **reward = é£é™©è°ƒæ•´æ”¶ç›Š**
* æ”¹æˆ **çœŸæ­£çš„ walk-forward RL æµ‹è¯•æ¡†æ¶**

ä½ æƒ³ç»§ç»­æ‹† **env** è¿˜æ˜¯ **reward è®¾è®¡**ï¼Ÿ

ä¸‹é¢æˆ‘ä¼š**æŠŠè¿™æ•´ä¸ª `ForexTradingEnv` å½“æˆä¸€å¥—â€œå¯æ•™å­¦çš„ RL äº¤æ˜“ç¯å¢ƒæ¨¡æ¿â€æ¥æ‹†**ï¼Œä» **Gym è§„èŒƒ â†’ çŠ¶æ€ / åŠ¨ä½œ / reward â†’ æ‰§è¡Œæµç¨‹ â†’ éšå«å‡è®¾ & é£é™©ç‚¹**ï¼Œä¸€æ­¥ä¸€æ­¥è®²æ¸…æ¥šã€‚

è¿™æ®µä»£ç æœ¬èº«å·²ç»**æ˜æ˜¾æ˜¯â€œæ‡‚ RL + æ‡‚äº¤æ˜“â€çš„äººå†™çš„**ï¼Œä¸æ˜¯ç©å…·çº§ï¼Œæˆ‘ä¼šåœ¨è§£é‡Šçš„åŒæ—¶æŒ‡å‡ºå“ªäº›åœ°æ–¹æ˜¯**è®¾è®¡é€‰æ‹©**ï¼Œå“ªäº›åœ°æ–¹æ˜¯**è¿‘ä¼¼å‡è®¾**ã€‚

---

# ä¸€ã€è¿™ä¸ªç¯å¢ƒåœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„è§’è‰²

ä¸€å¥è¯ï¼š

> **å®ƒæŠŠâ€œå†å²è¡Œæƒ… + æŠ€æœ¯æŒ‡æ ‡â€å°è£…æˆä¸€ä¸ª Gym ç¯å¢ƒï¼Œè®© PPO åƒç©æ¸¸æˆä¸€æ ·å­¦ä¼šâ€œä½•æ—¶åšå¤š / åšç©º / ä¸äº¤æ˜“ + é€‰ SL / TPâ€ã€‚**

åœ¨ RL è§†è§’ä¸‹ï¼š

| å…ƒç´                   | ä½ è¿™é‡Œçš„å®ç°                      |
| ------------------- | --------------------------- |
| Environment         | `ForexTradingEnv`           |
| State / Observation | æœ€è¿‘ `window_size` æ ¹ K çº¿ + æŒ‡æ ‡ |
| Action              | ç¦»æ•£çš„ï¼ˆæ–¹å‘ Ã— SL Ã— TP + ä¸äº¤æ˜“ï¼‰     |
| Reward              | ä¸‹ä¸€æ ¹ K çº¿å†…çš„ PnLï¼ˆè¿‘ä¼¼ï¼‰           |
| Episode             | è·‘å®Œæ•´ä¸ªå†å²æ•°æ®                    |

---

# äºŒã€ç±»å®šä¹‰ & æ€»ä½“æ³¨é‡Š

```python
class ForexTradingEnv(gym.Env):
```

* ç»§æ‰¿ `gym.Env`
* è¿™æ˜¯ **Stable-Baselines3 èƒ½è¯†åˆ«çš„æœ€ä½è¦æ±‚**

ç±»æ³¨é‡Šå·²ç»è¯´å¾—å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘è¡¥ä¸€å¥æ›´â€œå·¥ç¨‹åŒ–â€çš„æè¿°ï¼š

> **è¿™æ˜¯ä¸€ä¸ªâ€œå•æ­¥å†³ç­–ã€å³æ—¶ç»“ç®—â€çš„å¤–æ±‡äº¤æ˜“ç¯å¢ƒï¼ˆsingle-bar execution approximationï¼‰ã€‚**

---

# ä¸‰ã€`__init__`ï¼šç¯å¢ƒé…ç½®ä¸ç©ºé—´å®šä¹‰ï¼ˆæœ€å…³é”®ï¼‰

---

## 1ï¸âƒ£ æ•°æ®ä¸æ—¶é—´ç»´åº¦

```python
self.df = df.reset_index(drop=True)
self.n_steps = len(self.df)
```

### ä¸ºä»€ä¹ˆ `reset_index`ï¼Ÿ

* é˜²æ­¢æ—¶é—´ç´¢å¼•å¹²æ‰° `iloc / loc`
* Gym ç¯å¢ƒé‡Œé€šå¸¸ç”¨ **æ•´æ•° step**

ğŸ“Œ **ç»éªŒ**ï¼š

> äº¤æ˜“ç¯å¢ƒé‡Œï¼Œæ—¶é—´åªæ˜¯ä¸€æ¡éšå«è½´ï¼Œä¸åº”è¯¥ä½œä¸ºæ˜¾å¼ index

---

## 2ï¸âƒ£ Observation Window

```python
self.window_size = window_size
```

* æ¯ä¸€æ­¥ç»™ agentï¼š

  * æœ€è¿‘ `window_size` æ ¹ K çº¿
* ç­‰ä»·äº CNN / Transformer é‡Œçš„ **time window**

---

## 3ï¸âƒ£ SL / TP ç¦»æ•£åŒ–

```python
self.sl_options = sl_options if sl_options else [60, 90, 120]
self.tp_options = tp_options if tp_options else [60, 90, 120]
```

### è¿™æ˜¯ä¸€ä¸ª**éå¸¸é‡è¦çš„å»ºæ¨¡å†³ç­–**

ä½ æ²¡æœ‰ï¼š

* è®© agent å›å½’ä¸€ä¸ªè¿ç»­ SL
* è€Œæ˜¯ **æŠŠé£é™©æ§åˆ¶ç¦»æ•£åŒ–**

ä¼˜ç‚¹ï¼š

* æå¤§é™ä½ action space éš¾åº¦
* PPO æ›´ç¨³å®š
* æ›´æ¥è¿‘çœŸå®äº¤æ˜“å‘˜çš„â€œæ¡£ä½æ€ç»´â€

---

## 4ï¸âƒ£ Action Space æ„é€ ï¼ˆè®¾è®¡äº®ç‚¹ï¼‰

```python
self.action_map = [(None, None, None)]
```

### Action = 0

> **NO TRADE**

è¿™æ˜¯**99% äº¤æ˜“ RL æ•™ç¨‹é‡Œéƒ½ç¼ºå¤±çš„ä¸€æ­¥**ã€‚

å¦‚æœæ²¡æœ‰â€œä¸äº¤æ˜“â€ï¼š

* agent è¢«è¿«æ¯æ ¹ K çº¿éƒ½ä¸‹å•
* ç­–ç•¥ä¼šéå¸¸ä¸çœŸå®

---

### æ„é€ ç»„åˆåŠ¨ä½œ

```python
for direction in [0, 1]:
    for sl in self.sl_options:
        for tp in self.tp_options:
            self.action_map.append((direction, sl, tp))
```

åŠ¨ä½œè¯­ä¹‰ï¼š

| direction | å«ä¹‰    |
| --------- | ----- |
| 0         | Short |
| 1         | Long  |

---

### åŠ¨ä½œç©ºé—´å¤§å°

```python
self.action_space = spaces.Discrete(len(self.action_map))
```

å¦‚æœï¼š

* SL = 3
* TP = 3

é‚£ä¹ˆï¼š

```text
1 + 2 Ã— 3 Ã— 3 = 19 ä¸ªåŠ¨ä½œ
```

ğŸ“Œ **è¿™æ˜¯ä¸€ä¸ªéå¸¸ PPO-friendly çš„è§„æ¨¡**

---

## 5ï¸âƒ£ Observation Space

```python
self.num_features = self.df.shape[1]
```

å‡è®¾ä½ ä¼ å…¥çš„ df åŒ…å«ï¼š

* OHLCV
* RSI
* MA
* ATR
* slope

---

```python
self.observation_space = spaces.Box(
    low=-np.inf,
    high=np.inf,
    shape=(window_size, num_features),
    dtype=np.float32
)
```

### å«ä¹‰

* æ¯ä¸€æ­¥è¿”å›ä¸€ä¸ª **äºŒç»´çŸ©é˜µ**
* ç±»ä¼¼ï¼š

```text
[ [t-29 çš„ç‰¹å¾],
  [t-28 çš„ç‰¹å¾],
  ...
  [t çš„ç‰¹å¾] ]
```

ğŸ“Œ PPO é»˜è®¤ MLPï¼Œå¦‚æœä½ æ²¡æ”¹ policyï¼š

* SB3 ä¼šæŠŠè¿™ä¸ªçŸ©é˜µ **flatten æˆä¸€ç»´**
* ç­‰ä»·äºä¸€ä¸ªæ—¶é—´æ‹¼æ¥ç‰¹å¾å‘é‡

---

## 6ï¸âƒ£ å†…éƒ¨çŠ¶æ€

```python
self.current_step = 0
self.equity = 10000.0
```

* å•ä¸€è´¦æˆ·
* æ²¡æœ‰æ æ† / æ‰‹æ•°ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰

---

```python
self.positions = []
```

* ç°åœ¨æ²¡çœŸæ­£ç”¨åˆ°
* é¢„ç•™æ¥å£ï¼Œæœªæ¥å¯ä»¥æ‰©å±•æˆï¼š

  * å¤šå•
  * å¤š bar æŒä»“

---

## 7ï¸âƒ£ æ—¥å¿—å­—æ®µï¼ˆå¾ˆä¸“ä¸šï¼‰

```python
self.last_trade_info = None
```

ç”¨äºï¼š

* æµ‹è¯•è„šæœ¬è¯»å–
* ä¸æ±¡æŸ“ reward / state

è¿™æ˜¯**éå¸¸å¥½çš„ env / å¤–éƒ¨åˆ†ç¦»è®¾è®¡**ã€‚

---

# å››ã€`_get_observation()`ï¼šçŠ¶æ€æ„é€ 

```python
start = max(self.current_step - self.window_size, 0)
obs_df = self.df.iloc[start:self.current_step]
```

### å–æœ€è¿‘ `window_size` æ ¹æ•°æ®

---

### ä¸è¶³çª—å£çš„ padding

```python
if len(obs_df) < self.window_size:
    padding_rows = self.window_size - len(obs_df)
    first_part = np.tile(obs_df.iloc[0].values, (padding_rows, 1))
```

* ç”¨æœ€æ—©çš„ä¸€æ ¹æ•°æ®è¡¥é½
* ä¿è¯ observation shape **æ°¸è¿œä¸€è‡´**

ğŸ“Œ **Gym å¼ºçº¦æŸ**ï¼š

> observation shape ä¸èƒ½å˜

---

### è¾“å‡º float32

```python
return obs_array.astype(np.float32)
```

* PPO å†…éƒ¨ tensor é»˜è®¤ float32
* å‡å°‘éšå¼è½¬æ¢

---

# äº”ã€`_calculate_reward()`ï¼šæ ¸å¿ƒè¿‘ä¼¼æ¨¡å‹

è¿™æ˜¯æ•´ä¸ªç¯å¢ƒ**å‡è®¾æœ€å¼ºã€ä¹Ÿæœ€å±é™©çš„åœ°æ–¹**ã€‚

---

## 1ï¸âƒ£ è¿›åœºä»·

```python
entry_price = self.df.loc[self.current_step, "Close"]
```

* å‡è®¾ï¼š

  * åœ¨ bar close è¿›åœº
* ä¸è€ƒè™‘ï¼š

  * spread
  * æ»‘ç‚¹ï¼ˆä½ é¢„ç•™äº†å­—æ®µï¼‰

---

## 2ï¸âƒ£ ä½¿ç”¨â€œä¸‹ä¸€æ ¹ K çº¿â€æ¨¡æ‹Ÿæˆäº¤

```python
next_high = self.df.loc[self.current_step + 1, "High"]
next_low = self.df.loc[self.current_step + 1, "Low"]
```

ğŸ‘‰ **Single-bar execution approximation**

---

## 3ï¸âƒ£ pip â†’ price è½¬æ¢

```python
pip_value = 0.0001
sl_price_distance = sl * pip_value
```

è¿™æ˜¯ EURUSD ç‰¹æœ‰å‡è®¾ã€‚

---

## 4ï¸âƒ£ Long é€»è¾‘

```python
if direction == 1:
```

ä½ å¤„ç†äº† 4 ç§æƒ…å†µï¼š

1. SL & TP åŒæ—¶è§¦å‘ â†’ é»˜è®¤äº
2. åªè§¦å‘ SL â†’ äº
3. åªè§¦å‘ TP â†’ èµš
4. éƒ½æ²¡è§¦å‘ â†’ ç”¨ close åšæµ®åŠ¨æ”¶ç›Š

ğŸ“Œ **è¿™æ˜¯â€œä¿å®ˆåç©ºâ€çš„è®¾è®¡**
é˜²æ­¢ agent åˆ©ç”¨ OHLC åŒ bar é¡ºåºä¸ç¡®å®šæ€§ä½œå¼Šã€‚

---

## 5ï¸âƒ£ Short é€»è¾‘

```python
else:
```

å®Œå…¨å¯¹ç§°ï¼Œåªæ˜¯ä»·æ ¼æ–¹å‘ç›¸åã€‚

---

## 6ï¸âƒ£ Reward å®šä¹‰

```python
reward = pnl * 10000
```

* reward å•ä½ï¼š**pips**
* equity æ›´æ–°æ—¶ç›´æ¥åŠ  reward

âš ï¸ æ³¨æ„ï¼š

```python
self.equity += reward
```

è¿™æ„å‘³ç€ï¼š

* 1 pip = 1 ç¾å…ƒ
* æ²¡æœ‰ä»“ä½å¤§å°æ¦‚å¿µ

---

# å…­ã€`step()`ï¼šç¯å¢ƒæ¨è¿›

---

## 1ï¸âƒ£ è§£ç åŠ¨ä½œ

```python
direction, sl, tp = self.action_map[action]
```

**Discrete â†’ è¯­ä¹‰åŠ¨ä½œ**

---

## 2ï¸âƒ£ No Trade

```python
if direction is None:
```

* reward = 0
* equity ä¸å˜
* last_trade_info ç½®ç©º

è¿™æ˜¯éå¸¸çœŸå®çš„äº¤æ˜“è¡Œä¸ºã€‚

---

## 3ï¸âƒ£ æœ‰äº¤æ˜“

```python
reward = self._calculate_reward(...)
self.equity += reward
```

* å• bar å†³ç­–
* å³æ—¶ç»“ç®—
* ä¸æŒä»“

---

## 4ï¸âƒ£ æ­¥è¿›æ—¶é—´

```python
self.current_step += 1
self.done = self.current_step >= self.n_steps - 1
```

* Episode = æ•´æ®µå†å²

---

## 5ï¸âƒ£ è¿”å› Gym å››å…ƒç»„

```python
return obs, reward, self.done, {}
```

ç¬¦åˆ Gym æ¥å£ã€‚

---

# ä¸ƒã€`reset()`ï¼šæ–°ä¸€è½® Episode

```python
self.current_step = self.window_size
```

è¿™æ˜¯**éå¸¸å…³é”®çš„ä¸€è¡Œ**ï¼š

> ä¿è¯ä¸€å¼€å§‹ observation å°±æ˜¯å®Œæ•´çª—å£
> é¿å… padding å½±å“è®­ç»ƒ

---

# å…«ã€`render()`ï¼šè°ƒè¯•ç”¨

```python
print(f"Step: {self.current_step}, Equity: {self.equity}")
```

* éå¿…é¡»
* æ–¹ä¾¿æ‰‹åŠ¨ sanity check

---

# ä¹ã€æ•´ä½“è¯„ä»·ï¼ˆä¸“ä¸šè§’åº¦ï¼‰

### âœ… ä¼˜ç‚¹

* åŠ¨ä½œç©ºé—´è®¾è®¡åˆç†
* No-trade è®¾è®¡æˆç†Ÿ
* æ—¥å¿— & env è§£è€¦
* ç»“æ„æ¸…æ™°ï¼Œå¯æ‰©å±•

### âš ï¸ éšå«å‡è®¾ï¼ˆä½ å¿…é¡»æ¸…æ¥šï¼‰

1. å• bar æˆäº¤ï¼ˆéçœŸå®ï¼‰
2. æ—  spread / æ‰‹æ•° / æ æ†
3. reward ä¸ equity åŒé‡çº²
4. PPO å®é™…å­¦çš„æ˜¯ï¼š

   > **â€œä¸‹ä¸€æ ¹ K çº¿çš„æ–¹å‘ + æ³¢åŠ¨è¦†ç›–æ¦‚ç‡â€**

---

## åã€å¦‚æœä½ è¦â€œå†ä¸Šä¸€ä¸ªå°é˜¶â€

æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

1. æ”¹æˆ **å¤š bar æŒä»“ env**
2. åŠ å…¥ **é£é™©è°ƒæ•´ rewardï¼ˆSharpe / drawdown penaltyï¼‰**
3. é˜²æ­¢ **OHLC åŒ bar ä¿¡æ¯æ³„éœ²**
4. æŠŠ action space æ‹†æˆï¼š

   * trade / no trade
   * risk size
5. è®¾è®¡ä¸€ä¸ª **æ›´é€‚åˆè§†é¢‘å·è®²çš„äº¤æ˜“ RL Demo**

ä½ æ›´æƒ³å…ˆåŠ¨ **reward**ï¼Œè¿˜æ˜¯ **æŒä»“é€»è¾‘**ï¼Ÿ

ä¸‹é¢æˆ‘æŒ‰**â€œä»è®­ç»ƒåˆ°ä¸€æ¬¡å®Œæ•´è¯„ä¼°â€**çš„çœŸå® RL äº¤æ˜“æµç¨‹ï¼Œ**é€æ®µã€é€è¡Œ**ç»™ä½ æ‹†è§£è¿™æ®µä»£ç ï¼ŒåŒæ—¶ä¼šç©¿æ’è¯´æ˜ï¼š

* æ¯ä¸€è¡Œåœ¨ **Stable-Baselines3 + äº¤æ˜“åœºæ™¯**ä¸‹çš„çœŸå®å«ä¹‰
* å“ªäº›æ˜¯**å¿…éœ€å†™æ³•**ï¼Œå“ªäº›æ˜¯**ä½ å½“å‰è®¾è®¡é€‰æ‹©**
* å“ªäº›åœ°æ–¹åœ¨â€œç§‘ç ”/æ•™å­¦ OKâ€ï¼Œä½†â€œå®ç›˜/ä¸¥è°¨å›æµ‹è¦æ³¨æ„â€

---

# ä¸€ã€æ•´ä½“åŠŸèƒ½æ¦‚è§ˆï¼ˆä¸€å¥è¯ï¼‰

> **ç”¨ PPO åœ¨å†å² EURUSD 1H æ•°æ®ä¸Šè®­ç»ƒä¸€ä¸ª RL äº¤æ˜“ç­–ç•¥ï¼Œç„¶ååœ¨åŒä¸€æ®µæ•°æ®ä¸Šè·‘ä¸€éç­–ç•¥ï¼Œç”»å‡ºèµ„é‡‘æ›²çº¿ã€‚**

è¿™æ˜¯ä¸€ä¸ª**æœ€å°å¯è¿è¡Œï¼ˆMVPï¼‰çš„ RL äº¤æ˜“è®­ç»ƒè„šæœ¬**ã€‚

---

# äºŒã€å¯¼å…¥æ¨¡å—è¯´æ˜

```python
import numpy as np
import matplotlib.pyplot as plt
```

* `numpy`ï¼šåº•å±‚æ•°å€¼è¿ç®—ï¼ˆæœ¬æ–‡ä»¶å‡ ä¹æ²¡ç›´æ¥ç”¨ï¼‰
* `matplotlib`ï¼šå¯è§†åŒ– equity curve

---

```python
from stable_baselines3 import PPO
from stable_baselines3.common.vec_env import DummyVecEnv
```

### PPO

* on-policy RL ç®—æ³•
* å¯¹ noisy rewardã€ç¦»æ•£åŠ¨ä½œéå¸¸ç¨³
* éå¸¸é€‚åˆä½ è¿™ç§ï¼š

  > ç¦»æ•£æ–¹å‘ Ã— ç¦»æ•£ SL Ã— ç¦»æ•£ TP

### DummyVecEnv

* SB3 å¼ºåˆ¶è¦æ±‚ env æ˜¯ **VecEnv**
* å³ä½¿ä½ åªæœ‰ 1 ä¸ªç¯å¢ƒï¼Œä¹Ÿå¿…é¡»åŒ…ä¸€å±‚

---

```python
from indicators import load_and_preprocess_data
from trading_env import ForexTradingEnv
```

ä½ è‡ªå·±çš„æ¨¡å—ï¼š

| æ¨¡å—            | ä½œç”¨         |
| ------------- | ---------- |
| `indicators`  | è¡Œæƒ… â†’ ç‰¹å¾    |
| `trading_env` | Gym é£æ ¼äº¤æ˜“ç¯å¢ƒ |

---

# ä¸‰ã€`main()` ä¸»æµç¨‹

---

## Step 1ï¼šåŠ è½½ & é¢„å¤„ç†è¡Œæƒ…æ•°æ®

```python
df = load_and_preprocess_data(
    "data/EURUSD_Candlestick_1_Hour_BID_01.07.2020-15.07.2023.csv"
)
```

è¿™ä¸€æ­¥å®Œæˆï¼š

* è¯»å– CSV
* ç”Ÿæˆ RSI / MA / ATR ç­‰æŒ‡æ ‡
* åˆ é™¤ NaN
* è¿”å›ä¸€ä¸ª**å¯ç›´æ¥ç”¨äº RL çš„ç‰¹å¾çŸ©é˜µ**

ğŸ“Œ **æ³¨æ„**
è¿™é‡Œçš„æ—¶é—´æ®µ **åŒæ—¶ç”¨äºè®­ç»ƒå’Œè¯„ä¼°**ï¼Œå±äº **in-sample test**ã€‚

---

## Step 2ï¼šåˆ›å»ºäº¤æ˜“ç¯å¢ƒ

```python
env = ForexTradingEnv(
    df=df,
    window_size=30,
    sl_options=[30, 60, 80],
    tp_options=[30, 60, 80]
)
```

### å«ä¹‰

* æ¯ä¸€æ­¥è§‚å¯Ÿæœ€è¿‘ 30 æ ¹ K çº¿
* åŠ¨ä½œç©ºé—´ï¼š

  * ä¸äº¤æ˜“
  * Long / Short Ã— 3 SL Ã— 3 TP

ğŸ‘‰ ä¸€å…± **19 ä¸ªç¦»æ•£åŠ¨ä½œ**

ğŸ“Œ **é‡ç‚¹**

* è¿™äº›å‚æ•°å¿…é¡»åœ¨ï¼š

  * è®­ç»ƒ
  * æµ‹è¯•
  * å®ç›˜
    å®Œå…¨ä¸€è‡´

---

## Step 3ï¼šåŒ…è£…æˆ VecEnv

```python
vec_env = DummyVecEnv([lambda: env])
```

### ä¸ºä»€ä¹ˆä¸€å®šè¦è¿™æ ·ï¼Ÿ

Stable-Baselines3 çš„å†…éƒ¨è®¾è®¡æ˜¯ï¼š

```text
Env â†’ VecEnv â†’ Model
```

å³ä½¿ä½ åªæœ‰ 1 ä¸ªç¯å¢ƒï¼š

* `obs` ä¹Ÿä¼šå˜æˆ `(1, obs_dim)`

---

# å››ã€Step 4ï¼šå®šä¹‰ PPO æ¨¡å‹

```python
model = PPO(
    policy="MlpPolicy",
    env=vec_env,
    verbose=1,
    tensorboard_log="./tensorboard_log/"
)
```

### å‚æ•°è§£é‡Š

| å‚æ•°                   | å«ä¹‰      |
| -------------------- | ------- |
| `policy="MlpPolicy"` | å…¨è¿æ¥ç¥ç»ç½‘ç»œ |
| `env`                | å‘é‡åŒ–ç¯å¢ƒ   |
| `verbose=1`          | æ‰“å°è®­ç»ƒæ—¥å¿—  |
| `tensorboard_log`    | è¾“å‡ºè®­ç»ƒæŒ‡æ ‡  |

---

### ç½‘ç»œç»“æ„ï¼ˆéšå«ï¼‰

é»˜è®¤ `MlpPolicy` â‰ˆï¼š

```text
Flatten(obs)
 â†’ FC(64)
 â†’ FC(64)
 â†’ policy / value head
```

ğŸ“Œ **æ³¨æ„**

* ä½ çš„ observation æ˜¯ `(30, num_features)`
* SB3 ä¼šè‡ªåŠ¨ flatten
* ä¸ä½¿ç”¨æ—¶é—´å»ºæ¨¡ï¼ˆLSTM / Transformerï¼‰

---

# äº”ã€Step 5ï¼šè®­ç»ƒæ¨¡å‹

```python
model.learn(total_timesteps=10100)
```

### å«ä¹‰

* agent ä¸ç¯å¢ƒäº¤äº’ **10100 æ­¥**
* æ¯ä¸€æ­¥ = ä¸€æ ¹ K çº¿

ğŸ“Œ **æ•°é‡çº§è¯´æ˜**

* å¯¹ RL æ¥è¯´è¿™æ˜¯ **éå¸¸éå¸¸å°‘çš„**
* ä½†ä½œä¸ºï¼š

  * demo
  * æ•™å­¦
  * sanity check
    æ˜¯ OK çš„

---

```python
model.save("model_eurusd")
```

* ä¿å­˜ policy + value network + å‚æ•°
* ç”¨äºåç»­æµ‹è¯• / å®ç›˜

---

# å…­ã€Step 6ï¼šè¯„ä¼°ï¼ˆåœ¨åŒä¸€ç¯å¢ƒä¸Šï¼‰

âš ï¸ **è¿™æ˜¯è®­ç»ƒåç«‹å³åœ¨è®­ç»ƒé›†ä¸Šè·‘ä¸€é**

---

## 1ï¸âƒ£ reset ç¯å¢ƒ

```python
obs = vec_env.reset()
done = False
equity_curve = []
```

---

## 2ï¸âƒ£ ä¸»å›æµ‹å¾ªç¯

```python
while True:
```

---

### æ¨¡å‹å†³ç­–

```python
action, _states = model.predict(obs, deterministic=True)
```

* `deterministic=True`
* å…³é—­æ¢ç´¢
* å›ºå®šç­–ç•¥è¡Œä¸º

---

### ç¯å¢ƒæ¨è¿›

```python
obs, rewards, done, info = vec_env.step(action)
```

* `done` æ˜¯æ•°ç»„ï¼š

```python
done = [True/False]
```

---

### è¯»å– equity

```python
current_equity = vec_env.get_attr("equity")[0]
```

å› ä¸ºï¼š

* `DummyVecEnv`
* çœŸæ­£ env åœ¨å†…éƒ¨åˆ—è¡¨é‡Œ

---

### ç»“æŸæ¡ä»¶

```python
if done[0]:
    break
```

---

# ä¸ƒã€Step 7ï¼šç»˜åˆ¶èµ„é‡‘æ›²çº¿

```python
plt.plot(equity_curve)
```

### ä½ åœ¨è¿™é‡Œèƒ½çœ‹åˆ°ä»€ä¹ˆï¼Ÿ

* æ˜¯å¦æ•´ä½“ä¸Šå‡
* æ˜¯å¦é¢‘ç¹éœ‡è¡
* æ˜¯å¦æ—©æœŸç›´æ¥çˆ†ä»“

ğŸ“Œ **ç»éªŒæ³•åˆ™**

> å¦‚æœ equity curve çœ‹èµ·æ¥åƒå¿ƒç”µå›¾ï¼Œè€Œä¸æ˜¯é˜¶æ¢¯çŠ¶è¶‹åŠ¿
> é‚£ agent å¤§æ¦‚ç‡åªæ˜¯å­¦ä¼šäº†â€œå™ªå£°å¥—åˆ©â€

---

# å…«ã€è¿™æ®µä»£ç çš„â€œä¸“ä¸šçº§ç‚¹è¯„â€

### âœ… ä¼˜ç‚¹

* SB3 ä½¿ç”¨æ–¹å¼å®Œå…¨æ­£ç¡®
* åŠ¨ä½œ / è§‚æµ‹ç©ºé—´è®¾è®¡åˆç†
* è®­ç»ƒ â†’ ä¿å­˜ â†’ è¯„ä¼°å®Œæ•´é—­ç¯
* éå¸¸é€‚åˆï¼š

  * æ•™å­¦
  * è§†é¢‘æ¼”ç¤º
  * æ–‡ç« ç¤ºä¾‹

---

### âš ï¸ å±€é™ & é£é™©ï¼ˆä½ è‡ªå·±å¿ƒé‡Œä¸€å®šè¦æ¸…æ¥šï¼‰

1ï¸âƒ£ **è®­ç»ƒ & è¯„ä¼°æ•°æ®é‡å **

* æ›²çº¿åªèƒ½è¯´æ˜ï¼š

  > â€œæ¨¡å‹èƒ½ä¸èƒ½æ‹Ÿåˆè¿™æ®µå†å²â€

2ï¸âƒ£ **reward æ˜¯å• bar è¿‘ä¼¼**

* agent å®é™…å­¦çš„æ˜¯ï¼š

  > ä¸‹ä¸€æ ¹ K çº¿æ–¹å‘ + æ³¢åŠ¨èŒƒå›´

3ï¸âƒ£ **æ²¡æœ‰ position sizing**

* equity å˜åŒ–çº¿æ€§
* ä¸ç¬¦åˆçœŸå®è´¦æˆ·å¢é•¿

---

# ä¹ã€å¦‚æœä½ æƒ³æŠŠå®ƒå‡çº§æˆâ€œæ›´çœŸå®çš„é‡åŒ– RLâ€

æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšä¸‹é¢ä»»æ„ä¸€ä»¶ï¼š

1. **Train / Test / Walk-forward åˆ†ç¦»**
2. PPO + LSTMï¼ˆçœŸæ­£åˆ©ç”¨æ—¶é—´åºåˆ—ï¼‰
3. Reward æ”¹æˆï¼š

   * Sharpe-adjusted
   * Drawdown-penalized
4. å¤š bar æŒä»“ envï¼ˆçœŸæ­£åƒäº¤æ˜“ï¼‰
5. ç»™ä½ ä¸€å¥— **é€‚åˆå…¬å¼€è§†é¢‘è®²çš„ RL äº¤æ˜“ Demo æ¶æ„**

ä½ æƒ³å…ˆå‡çº§ **å“ªä¸€å±‚**ï¼Ÿ
